{% extends 'base.html' %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Prompts Table -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Saved Prompts</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-primary" onclick="createNewPrompt()">
                            <i class="bi bi-plus-circle"></i> New Prompt
                        </button>
                        <button class="btn btn-sm btn-success" onclick="createPromptFromSchema()">
                            <i class="bi bi-database-add"></i> Generate from Schema
                        </button>
                        <button class="btn btn-sm btn-info" onclick="loadSchemaFromFile()">
                            <i class="bi bi-file-earmark-arrow-down"></i> Load Schema
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Schema status indicator -->
                    <div class="alert alert-info schema-status mb-3" id="schemaStatus">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <i class="bi bi-info-circle-fill me-2"></i>
                                <span id="schemaMessage">Checking schema status...</span>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="toggleSchemaConfig()">
                                    <i class="bi bi-gear"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary ms-1" onclick="toggleHelpPanel()">
                                    <i class="bi bi-question-circle"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Schema configuration -->
                        <div id="schemaConfig" class="mt-3" style="display: none;">
                            <div class="form-group mb-2">
                                <label class="form-label">Schema File Path</label>
                                <input type="text" id="schemaFilePath" class="form-control" 
                                       value="/Users/chrisjanssen/Insync/cnjanssen@tamu.edu/Google Drive/COM/Research/human_vs_llm/human_reviewer_django/extraction_schema_dump.json">
                            </div>
                            <div class="form-check mb-2">
                                <input type="checkbox" id="clearExisting" class="form-check-input" checked>
                                <label class="form-check-label" for="clearExisting">Clear existing columns</label>
                            </div>
                            <div class="d-grid">
                                <button class="btn btn-primary btn-sm" onclick="loadSchemaFromFilePath()">
                                    <i class="bi bi-arrow-repeat"></i> Load Schema from File
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Help Panel -->
                    <div class="card mb-3" id="helpPanel" style="display: none;">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Schema Integration Help</h6>
                            <button class="btn btn-sm btn-close" onclick="toggleHelpPanel()"></button>
                        </div>
                        <div class="card-body">
                            <h6>What is Schema Integration?</h6>
                            <p>Schema integration allows you to load column definitions from an external JSON schema file and automatically generate prompts based on these definitions.</p>
                            
                            <h6>Options:</h6>
                            <ol>
                                <li><strong>Generate from Schema</strong> - Creates a prompt from existing loaded columns without loading new ones</li>
                                <li><strong>Load Schema</strong> - Loads schema from a JSON file and optionally creates a prompt</li>
                            </ol>
                            
                            <h6>File Path:</h6>
                            <p>The default path is set to the extraction schema from the human_vs_llm project. You can modify this path to point to any compatible JSON schema file.</p>
                            
                            <h6>Schema Structure:</h6>
                            <p>The schema file should contain fields with names, labels, types, and descriptions. These will be mapped to appropriate categories in the system.</p>
                            
                            <div class="alert alert-secondary">
                                <strong>Command-line Alternative:</strong><br>
                                <code>python manage.py load_default_columns --clear</code>
                            </div>
                        </div>
                    </div>
                    
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="promptsTableBody">
                            <!-- Prompts will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Editor Panel -->
        <div class="col-md-6">
            <div class="card" id="editorPanel">
                <div class="card-header">
                    <input type="text" id="promptName" class="form-control" placeholder="Prompt Name">
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Variables</label>
                        <input type="text" id="disease_condition" class="form-control mb-2" placeholder="Disease Condition">
                        <input type="text" id="population_age" class="form-control mb-2" placeholder="Population Age">
                        <input type="text" id="grading_of_lesion" class="form-control mb-2" placeholder="Grading of Lesion">
                    </div>
                    <div class="form-group mt-3">
                        <label>Prompt Template</label>
                        <textarea id="promptEditor" class="form-control" rows="10"></textarea>
                    </div>
                    <div class="btn-group mt-3">
                        <button class="btn btn-primary" onclick="savePrompt()">
                            <i class="bi bi-save"></i> Save
                        </button>
                        <button class="btn btn-danger" onclick="deletePrompt()">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
#editorPanel {
    position: sticky;
    top: 20px;
}
.table td {
    vertical-align: middle;
}
.schema-status {
    display: flex;
    align-items: center;
}
</style>

<script>
let currentPromptId = null;

function loadPrompts() {
    fetch('/prompts/list/')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('promptsTableBody');
            tbody.innerHTML = data.prompts.map(p => `
                <tr>
                    <td>${p.name}</td>
                    <td>${new Date(p.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editPrompt(${p.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deletePrompt(${p.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        });
    
    // Check schema status
    checkSchemaStatus();
}

function checkSchemaStatus() {
    // Check if columns exist by making a simple fetch request
    fetch('/columns/?format=json')
        .then(response => response.json())
        .then(data => {
            const statusEl = document.getElementById('schemaStatus');
            const messageEl = document.getElementById('schemaMessage');
            
            if (data.columns && data.columns.length > 0) {
                // Check if we have the schema columns loaded
                const schemaColumns = data.columns.filter(col => 
                    col.name === 'loss_of_bladder_control' || 
                    col.name === 'neruopathyradiculopathy' ||
                    col.name === 'mass' ||
                    col.name === 'headache');
                
                if (schemaColumns.length >= 3) {
                    // Schema columns from load_default_columns are present
                    statusEl.classList.remove('alert-info', 'alert-warning');
                    statusEl.classList.add('alert-success');
                    messageEl.innerHTML = '<strong>Schema Loaded:</strong> The extraction schema has been loaded. You can generate prompts based on this schema.';
                } else {
                    // Regular columns exist but not schema columns
                    statusEl.classList.remove('alert-info', 'alert-success');
                    statusEl.classList.add('alert-warning');
                    messageEl.innerHTML = '<strong>Custom Schema:</strong> Custom column definitions are loaded, but not the default extraction schema. Run <code>python manage.py load_default_columns --clear</code> to load the schema.';
                }
            } else {
                // No columns exist
                statusEl.classList.remove('alert-success', 'alert-info');
                statusEl.classList.add('alert-warning');
                messageEl.innerHTML = '<strong>No Schema:</strong> No column definitions found. Run <code>python manage.py load_default_columns --clear</code> to load the schema.';
            }
        })
        .catch(error => {
            console.error('Error checking schema status:', error);
            document.getElementById('schemaMessage').textContent = 'Error checking schema status';
        });
}

function editPrompt(id) {
    fetch(`/prompts/${id}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            currentPromptId = id;
            document.getElementById('promptName').value = data.name;
            
            // Handle variables safely
            const variables = data.variables || {};
            document.getElementById('disease_condition').value = variables.disease_condition || '';
            document.getElementById('population_age').value = variables.population_age || '';
            document.getElementById('grading_of_lesion').value = variables.grading_of_lesion || '';
            
            document.getElementById('promptEditor').value = data.content;
        })
        .catch(error => {
            alert('Error loading prompt: ' + error);
            console.error('Error loading prompt:', error);
        });
}

// Load prompts on page load
document.addEventListener('DOMContentLoaded', loadPrompts);

function savePrompt() {
    const name = document.getElementById('promptName').value;
    const content = document.getElementById('promptEditor').value;
    
    // Collect variables
    const variables = {
        disease_condition: document.getElementById('disease_condition').value,
        population_age: document.getElementById('population_age').value,
        grading_of_lesion: document.getElementById('grading_of_lesion').value
    };
    
    const data = {
        name: name,
        content: content,
        variables: variables
    };
    
    const url = currentPromptId ? `/prompts/${currentPromptId}/` : '/save_prompt/';
    const method = currentPromptId ? 'POST' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            loadPrompts();
            alert('Prompt saved successfully!');
        } else {
            alert('Error saving prompt: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error saving prompt: ' + error);
        console.error('Error saving prompt:', error);
    });
}

function createPromptFromSchema() {
    // Get a name for the new schema-based prompt
    const now = new Date();
    const defaultName = `Schema-Based Prompt (${now.toLocaleDateString()})`;
    const promptName = prompt("Enter a name for the schema-based prompt:", defaultName);
    
    if (!promptName) return;  // User cancelled
    
    // Make request to create prompt from schema
    fetch('/create_prompt_from_columns/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            name: promptName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadPrompts();
            // Edit the newly created prompt
            editPrompt(data.prompt_id);
            alert(`Schema-based prompt "${data.name}" created successfully!`);
        } else {
            alert('Error creating schema-based prompt: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
        console.error('Error creating schema-based prompt:', error);
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function createNewPrompt() {
    currentPromptId = null;
    document.getElementById('promptName').value = '';
    document.getElementById('disease_condition').value = '';
    document.getElementById('population_age').value = '';
    document.getElementById('grading_of_lesion').value = '';
    document.getElementById('promptEditor').value = '';
}

function deletePrompt(id) {
    if (!confirm('Are you sure you want to delete this prompt?')) {
        return;
    }
    
    const promptId = id || currentPromptId;
    if (!promptId) {
        return;
    }
    
    fetch(`/prompts/${promptId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            loadPrompts();
            if (currentPromptId === promptId) {
                createNewPrompt();
            }
            alert('Prompt deleted successfully!');
        } else {
            alert('Error deleting prompt: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error deleting prompt: ' + error);
        console.error('Error deleting prompt:', error);
    });
}

function toggleSchemaConfig() {
    const configDiv = document.getElementById('schemaConfig');
    if (configDiv.style.display === 'none') {
        configDiv.style.display = 'block';
    } else {
        configDiv.style.display = 'none';
    }
}

function loadSchemaFromFile() {
    // Show the configuration panel
    document.getElementById('schemaConfig').style.display = 'block';
    
    // Focus on the file path input
    document.getElementById('schemaFilePath').focus();
}

function loadSchemaFromFilePath() {
    const filePath = document.getElementById('schemaFilePath').value;
    const clearExisting = document.getElementById('clearExisting').checked;
    
    if (!filePath) {
        alert('Please provide a file path');
        return;
    }
    
    // Show loading indicator
    const statusEl = document.getElementById('schemaStatus');
    const messageEl = document.getElementById('schemaMessage');
    statusEl.classList.remove('alert-success', 'alert-danger', 'alert-warning');
    statusEl.classList.add('alert-info');
    messageEl.innerHTML = '<strong>Loading...</strong> Processing schema file...';
    
    // Make the API request
    fetch('/columns/load-schema-from-file/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            file_path: filePath,
            clear_existing: clearExisting
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update status indicator
            statusEl.classList.remove('alert-info', 'alert-danger', 'alert-warning');
            statusEl.classList.add('alert-success');
            
            let message = `<strong>Success!</strong> ${data.message}`;
            if (data.prompt_created) {
                message += ` <a href="#" onclick="editPrompt(${data.prompt_id}); return false;">View generated prompt</a>`;
            }
            
            messageEl.innerHTML = message;
            
            // Refresh the prompts list
            loadPrompts();
            
            // Hide the config after successful load
            setTimeout(() => {
                document.getElementById('schemaConfig').style.display = 'none';
            }, 3000);
        } else {
            // Show error
            statusEl.classList.remove('alert-info', 'alert-success', 'alert-warning');
            statusEl.classList.add('alert-danger');
            messageEl.innerHTML = `<strong>Error:</strong> ${data.error}`;
        }
    })
    .catch(error => {
        // Show error
        statusEl.classList.remove('alert-info', 'alert-success', 'alert-warning');
        statusEl.classList.add('alert-danger');
        messageEl.innerHTML = `<strong>Error:</strong> ${error.message}`;
        console.error('Error loading schema:', error);
    });
}

function toggleHelpPanel() {
    const helpPanel = document.getElementById('helpPanel');
    if (helpPanel.style.display === 'none') {
        helpPanel.style.display = 'block';
    } else {
        helpPanel.style.display = 'none';
    }
}
</script>
{% endblock %}
