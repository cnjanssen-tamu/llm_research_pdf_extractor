{% extends "base.html" %}
{% load static %}

{% block title %}AI Case Report Generator{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>{{ title|default:"AI Case Report Generator" }}</h2>
    <p class="text-muted">{{ subtitle|default:"Generate a draft case report from de-identified patient data" }}</p>

    <div class="alert alert-warning" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i> <strong>Important:</strong> Ensure all uploaded files and entered text are completely <strong>DE-IDENTIFIED</strong> and contain no Protected Health Information (PHI). The generated report is a DRAFT and requires thorough review by a qualified medical professional.
    </div>

    {% if case_report and case_report.status == 'completed' %}
        <div class="alert alert-success" role="alert">
            <i class="bi bi-check-circle-fill"></i> <strong>Success!</strong> Your case report draft has been generated.
        </div>
    {% elif case_report and case_report.status == 'failed' %}
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-x-circle-fill"></i> <strong>Error:</strong> {{ case_report.error_message }}
        </div>
    {% elif case_report and case_report.status in 'researching,drafting' %}
        <div class="alert alert-info" role="alert">
            <i class="bi bi-hourglass-split"></i> <strong>Processing:</strong> Your case report is currently being generated. Status: {{ case_report.get_status_display }}
        </div>
    {% endif %}

    <form id="case-report-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Report Information</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    {{ form.name.label_tag }}
                    {{ form.name }}
                    {% if form.name.errors %}<div class="invalid-feedback d-block">{{ form.name.errors }}</div>{% endif %}
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">1. Provide Patient Context (Optional)</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        {{ form.patient_age.label_tag }}
                        {{ form.patient_age }}
                        {% if form.patient_age.errors %}<div class="invalid-feedback d-block">{{ form.patient_age.errors }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        {{ form.patient_gender.label_tag }}
                        {{ form.patient_gender }}
                        {% if form.patient_gender.errors %}<div class="invalid-feedback d-block">{{ form.patient_gender.errors }}</div>{% endif %}
                    </div>
                    <div class="col-12">
                        {{ form.suspected_condition.label_tag }}
                        {{ form.suspected_condition }}
                        {% if form.suspected_condition.errors %}<div class="invalid-feedback d-block">{{ form.suspected_condition.errors }}</div>{% endif %}
                    </div>
                    <div class="col-12">
                        {{ form.key_findings_summary.label_tag }}
                        {{ form.key_findings_summary }}
                        {% if form.key_findings_summary.errors %}<div class="invalid-feedback d-block">{{ form.key_findings_summary.errors }}</div>{% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">2. Upload De-Identified Documents (Optional PDFs)</h5>
            </div>
            <div class="card-body">
                 <div class="row g-3">
                     <div class="col-md-6 mb-3">
                         {{ form.patient_history_pdf.label_tag }}
                         {{ form.patient_history_pdf }}
                         {% if form.patient_history_pdf.errors %}<div class="invalid-feedback d-block">{{ form.patient_history_pdf.errors }}</div>{% endif %}
                     </div>
                     <div class="col-md-6 mb-3">
                         {{ form.clinical_findings_pdf.label_tag }}
                         {{ form.clinical_findings_pdf }}
                         {% if form.clinical_findings_pdf.errors %}<div class="invalid-feedback d-block">{{ form.clinical_findings_pdf.errors }}</div>{% endif %}
                     </div>
                     <div class="col-md-6 mb-3">
                         {{ form.lab_results_pdf.label_tag }}
                         {{ form.lab_results_pdf }}
                         {% if form.lab_results_pdf.errors %}<div class="invalid-feedback d-block">{{ form.lab_results_pdf.errors }}</div>{% endif %}
                     </div>
                     <div class="col-md-6 mb-3">
                         {{ form.imaging_reports_pdf.label_tag }}
                         {{ form.imaging_reports_pdf }}
                         {% if form.imaging_reports_pdf.errors %}<div class="invalid-feedback d-block">{{ form.imaging_reports_pdf.errors }}</div>{% endif %}
                     </div>
                     <div class="col-md-6 mb-3">
                         {{ form.treatment_summary_pdf.label_tag }}
                         {{ form.treatment_summary_pdf }}
                         {% if form.treatment_summary_pdf.errors %}<div class="invalid-feedback d-block">{{ form.treatment_summary_pdf.errors }}</div>{% endif %}
                     </div>
                 </div>
                 {% if form.non_field_errors %}
                    <div class="alert alert-danger mt-3">
                        {{ form.non_field_errors }}
                    </div>
                 {% endif %}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">3. Additional Instructions for AI (Optional)</h5>
            </div>
            <div class="card-body">
                {{ form.additional_instructions.label_tag }}
                {{ form.additional_instructions }}
                {% if form.additional_instructions.errors %}<div class="invalid-feedback d-block">{{ form.additional_instructions.errors }}</div>{% endif %}
            </div>
        </div>

        <div class="card mb-4">
             <div class="card-header">
                 <h5 class="mb-0">4. Confirmation</h5>
             </div>
             <div class="card-body">
                 <div class="form-check">
                     {{ form.de_identification_confirmed }}
                     {{ form.de_identification_confirmed.label_tag }}
                     {% if form.de_identification_confirmed.errors %}
                         <div class="invalid-feedback d-block">
                             {{ form.de_identification_confirmed.errors }}
                         </div>
                     {% endif %}
                 </div>
             </div>
         </div>

        <div class="mt-3 mb-4">
            <button type="submit" id="generate-button" class="btn btn-primary btn-lg">
                <i class="bi bi-pencil-square"></i> Generate Draft Report
            </button>
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="spinner-border text-primary ms-3" role="status" style="display: none;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </form>

    {% if case_report and case_report.draft_response %}
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Generated Draft Case Report</h5>
             <button class="btn btn-sm btn-outline-secondary" onclick="copyReportToClipboard('draft-report-output')">
                 <i class="bi bi-clipboard"></i> Copy Report
             </button>
        </div>
        <div class="card-body">
            {% if case_report.draft_response|slice:":7" == "[Error:" %}
                <div class="alert alert-danger">
                    <strong>Error during generation:</strong> {{ case_report.draft_response }}
                </div>
            {% else %}
                <textarea id="draft-report-output" class="form-control" rows="25" readonly>{{ case_report.draft_response }}</textarea>
                <small class="form-text text-muted mt-2">Review and edit this draft carefully. You can copy the text using the button above.</small>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if case_report and case_report.research_response %}
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Research Information (from Perplexity AI)</h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="copyReportToClipboard('research-output')">
                <i class="bi bi-clipboard"></i> Copy Research
            </button>
        </div>
        <div class="card-body">
            {% if case_report.research_response|slice:":7" == "[Error:" %}
                <div class="alert alert-danger">
                    <strong>Error during research:</strong> {{ case_report.research_response }}
                </div>
            {% else %}
                <textarea id="research-output" class="form-control" rows="15" readonly>{{ case_report.research_response }}</textarea>
                <small class="form-text text-muted mt-2">This research information was used to inform the case report draft.</small>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if case_report and case_report.draft_prompt %}
    <div class="card mt-4">
        <div class="card-header">
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#draftPromptCollapse" aria-expanded="false" aria-controls="draftPromptCollapse">
                Show/Hide Draft Generation Prompt
            </button>
        </div>
        <div class="collapse" id="draftPromptCollapse">
            <div class="card-body bg-light">
                <pre style="white-space: pre-wrap; word-wrap: break-word;"><code>{{ case_report.draft_prompt }}</code></pre>
            </div>
        </div>
    </div>
    {% endif %}

    {% if case_report and case_report.research_prompt %}
    <div class="card mt-4">
        <div class="card-header">
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#researchPromptCollapse" aria-expanded="false" aria-controls="researchPromptCollapse">
                Show/Hide Research Prompt
            </button>
        </div>
        <div class="collapse" id="researchPromptCollapse">
            <div class="card-body bg-light">
                <pre style="white-space: pre-wrap; word-wrap: break-word;"><code>{{ case_report.research_prompt }}</code></pre>
            </div>
        </div>
    </div>
    {% endif %}

</div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('case-report-form');
    const generateButton = document.getElementById('generate-button');
    const loadingIndicator = document.getElementById('loading-indicator');

    if(form) {
        form.addEventListener('submit', function() {
            // Show loading indicator and disable button on submit
            if(generateButton) generateButton.disabled = true;
            if(loadingIndicator) loadingIndicator.style.display = 'inline-block';
        });
    }

    // If the page loaded with a report, re-enable the button
    const draftReportOutput = document.getElementById('draft-report-output');
    if (draftReportOutput && draftReportOutput.value) {
         if(generateButton) generateButton.disabled = false;
         if(loadingIndicator) loadingIndicator.style.display = 'none';
    }
});

function copyReportToClipboard(elementId) {
    const reportText = document.getElementById(elementId);
    if (reportText) {
        reportText.select(); // Select the text
        try {
            navigator.clipboard.writeText(reportText.value)
                .then(() => {
                    alert('Text copied to clipboard!');
                })
                .catch(err => {
                    console.error('Failed to copy text: ', err);
                    // Fallback for older browsers (less reliable)
                    document.execCommand('copy');
                    alert('Text copied (using fallback method).');
                });
        } catch (err) {
             console.error('Clipboard API not available: ', err);
             // Fallback for older browsers
             try {
                document.execCommand('copy');
                alert('Text copied (using fallback method).');
             } catch (copyErr) {
                 alert('Failed to copy text. Please copy manually.');
             }
        }
        // Deselect text after copying
        window.getSelection().removeAllRanges();
    } else {
        alert('Could not find text to copy.');
    }
}

</script>
{% endblock extra_js %} 