{% extends "base.html" %}
{% load custom_filters %}
{% load static %}

{% block content %}
<div class="container">
    <h2>PDF Processor</h2>

    {% if prompt_error %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        {{ prompt_error }}
        <button type="button" class="btn btn-sm btn-outline-primary ms-3" onclick="useDefaultPrompt()">
            Use Default Prompt
        </button>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h3 class="card-title mb-0">Active Prompt</h3>
                <small class="text-muted">
                    {% if active_prompt_source == 'saved' %}
                        <span class="badge bg-primary">Saved: {{ active_prompt_name }}</span>
                    {% elif active_prompt_source == 'column-definition' %}
                        <span class="badge bg-success">Column-Generated</span>
                    {% else %}
                        <span class="badge bg-warning text-dark">Default</span>
                    {% endif %}
                </small>
            </div>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary" id="toggle-active-prompt">
                    <i class="bi bi-arrows-expand"></i> Show Prompt
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="editPrompt()">
                    Edit Prompt
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadDefaultPrompt()">
                    Load Default
                </button>
                {% if column_prompt %}
                <button class="btn btn-sm btn-outline-success" onclick="loadColumnPrompt()">
                    Use Column Prompt
                </button>
                {% endif %}
            </div>
        </div>
        <div class="card-body" id="active-prompt-container" style="display: none;">
            <pre id="active-prompt" class="bg-light p-3 rounded">{{ active_prompt.content }}</pre>
        </div>
    </div>

    <!-- Schema Info Card -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h3 class="card-title mb-0">Active Schema</h3>
                <small class="text-muted">
                    {% if columns %}
                        <span class="badge bg-success">{{ columns|length }} Columns Loaded</span>
                    {% else %}
                        <span class="badge bg-warning text-dark">No Schema Loaded</span>
                    {% endif %}
                </small>
            </div>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary" id="toggle-schema-info">
                    <i class="bi bi-arrows-expand"></i> Show Schema Info
                </button>
                <a href="{% url 'core:columns' %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-table"></i> Manage Columns
                </a>
                <a href="{% url 'core:prompts' %}" class="btn btn-sm btn-outline-success">
                    <i class="bi bi-gear"></i> Schema Settings
                </a>
            </div>
        </div>
        <div class="card-body" id="schema-info-container" style="display: none;">
            {% if columns %}
                <p><strong>Schema Status:</strong> Using <code>{{ columns|length }}</code> columns for structured extraction</p>
                
                <div class="row">
                    {% for category, cols in columns_by_category.items %}
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header">
                                    <i class="bi {{ category_icons|get_item:category }} me-2"></i> 
                                    {{ category_names|get_item:category }}
                                </div>
                                <div class="card-body">
                                    <p class="card-text">
                                        <small>{{ cols|length }} columns</small>
                                    </p>
                                    <ul class="list-group list-group-flush small">
                                        {% for col in cols|slice:":5" %}
                                            <li class="list-group-item text-truncate" title="{{ col.name }}: {{ col.description }}">
                                                {{ col.name }}
                                            </li>
                                        {% endfor %}
                                        {% if cols|length > 5 %}
                                            <li class="list-group-item text-muted">
                                                + {{ cols|length|subtract:5 }} more...
                                            </li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Using structured schema format with Gemini for high-quality extraction.
                </div>
            {% else %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>No schema columns loaded.</strong> Visit the <a href="{% url 'core:prompts' %}">Schema Settings</a> page to load the schema.
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Upload Section -->
    <div class="upload-section mb-4">
        <h2>Upload Medical Literature PDFs</h2>
        
        <!-- Debug Controls (for testing) -->
        <div class="alert alert-secondary mb-3" id="debug-controls" style="display: none;">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Debug Controls</h5>
                <button type="button" class="btn-close" onclick="document.getElementById('debug-controls').style.display='none'"></button>
            </div>
            <hr>
            <div class="d-flex gap-2 flex-wrap">
                <button type="button" id="btn-test-visibility" class="btn btn-sm btn-warning">
                    <i class="bi bi-eye"></i> Test Status Display
                </button>
                <button type="button" id="btn-test-status" class="btn btn-sm btn-primary">
                    <i class="bi bi-arrow-repeat"></i> Test Status Updates
                </button>
                <button type="button" id="btn-show-status" class="btn btn-sm btn-success">
                    <i class="bi bi-check2-circle"></i> Force Show Status
                </button>
                <button type="button" class="btn btn-sm btn-info" onclick="window.location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Reload Page
                </button>
            </div>
        </div>
        
        <form id="upload-form" method="post" enctype="multipart/form-data" action="{% url 'core:processor' %}">
            {% csrf_token %}
            <div class="mb-3">
                <label for="id_name" class="form-label">Job Name</label>
                {{ form.name }}
            </div>
            
            <!-- Show Debug Controls button -->
            <div class="mb-3 text-end">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('debug-controls').style.display='block'">
                    <i class="bi bi-tools"></i> Debug Controls
                </button>
            </div>

            <!-- Collapsible Prompt Editor -->
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <label for="id_prompt_template" class="form-label">Processing Prompt</label>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="toggle-prompt-editor">
                        <i class="bi bi-arrows-expand"></i> Expand
                    </button>
                </div>
                <div id="prompt-editor-container" style="display: none;"> <!-- Hidden by default -->
                    <textarea id="id_prompt_template" name="prompt_template" class="form-control" rows="15">{{ active_prompt.content }}</textarea>
                </div>
            </div>

            <!-- Add this after the prompt editor -->
            <div class="card mb-3" id="debug-info" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Debug Information</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('debug-info').style.display='none'">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <div class="card-body">
                    <h6>Current State:</h6>
                    <pre class="bg-light p-3 rounded"><code id="debug-state"></code></pre>
                    <h6>API Request:</h6>
                    <pre class="bg-light p-3 rounded"><code id="debug-request"></code></pre>
                    <h6>API Response:</h6>
                    <pre class="bg-light p-3 rounded"><code id="debug-response"></code></pre>
                    <h6>Processed Results:</h6>
                    <pre class="bg-light p-3 rounded"><code id="debug-results"></code></pre>
                </div>
            </div>

            <div class="mb-3">
                <button type="button" class="btn btn-sm btn-outline-info" onclick="debugPrompt()">
                    <i class="bi bi-bug"></i> Debug Prompt
                </button>
            </div>

            <div class="mb-3">
                <label for="id_pdf_files" class="form-label">PDF Files</label>
                {{ form.pdf_files }}
            </div>

            <!-- PDF Files Table (initially hidden) -->
            <div id="pdf-files-table" class="mb-3" style="display: none;">
                <h5>Edit PDF Information</h5>
                <p class="text-muted small">Edit the case report name and study author for each PDF file</p>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Original Filename</th>
                                <th>Case Report Name</th>
                                <th>Study Author</th>
                            </tr>
                        </thead>
                        <tbody id="pdf-files-list">
                            <!-- PDF files will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn btn-primary" name="process_type" value="per_page">Process PDFs per page</button>
                <button type="submit" id="extraction-button" class="btn btn-primary" name="process_type" value="with_extraction">Process PDFs using LLM extraction</button>
            </div>
            
            <!-- Loading indicator - hidden by default -->
            <div id="form-processing-indicator" class="mt-3" style="display: none;">
                <div class="d-flex align-items-center">
                    <div class="spinner-border text-primary me-2" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                    <div>
                        <strong>Processing PDFs...</strong>
                        <p class="text-muted mb-0">Please wait while we extract information from your documents.</p>
                    </div>
                </div>
            </div>
        </form>
    </div>

<!-- Add this modal for errors -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Processing Error</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="error-modal-content"></div>
        </div>
    </div>
</div>

    <!-- Processing Status Section -->
    <div id="results-section" class="mt-4" style="display: none;">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">Processing Progress</h3>
            <span id="processing-status-badge" class="badge bg-info">Initializing</span>
        </div>
        <div class="card-body">
            <div id="processing-status">
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0"></div>
                </div>
                
                <!-- Processing steps visualization -->
                <div class="processing-steps mb-3">
                    <div class="d-flex justify-content-between position-relative">
                        <div class="processing-step">
                            <div class="step-indicator active" data-phase="initializing">
                                <span class="step-number">1</span>
                            </div>
                            <div class="step-label">Initialize</div>
                        </div>
                        <div class="processing-step">
                            <div class="step-indicator" data-phase="preparing">
                                <span class="step-number">2</span>
                            </div>
                            <div class="step-label">Prepare</div>
                        </div>
                        <div class="processing-step">
                            <div class="step-indicator" data-phase="sending">
                                <span class="step-number">3</span>
                            </div>
                            <div class="step-label">Send</div>
                        </div>
                        <div class="processing-step">
                            <div class="step-indicator" data-phase="extracting">
                                <span class="step-number">4</span>
                            </div>
                            <div class="step-label">Extract</div>
                        </div>
                        <div class="processing-step">
                            <div class="step-indicator" data-phase="processing">
                                <span class="step-number">5</span>
                            </div>
                            <div class="step-label">Process</div>
                        </div>
                        <div class="processing-step">
                            <div class="step-indicator" data-phase="completed">
                                <span class="step-number">6</span>
                            </div>
                            <div class="step-label">Complete</div>
                        </div>
                        <!-- Progress line connecting steps -->
                        <div class="progress-line"></div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between mb-3">
                    <div id="processing-info">
                        <span id="processed-count">0</span> of <span id="total-count">0</span> documents processed
                    </div>
                    <div id="case-counter" class="text-primary" style="display: none;">
                        <i class="bi bi-file-earmark-text"></i> <span id="case-count">0</span> cases extracted
                    </div>
                </div>
                <!-- Truncation warning -->
                <div id="truncation-alert" class="alert alert-warning alert-dismissible fade show mb-3" role="alert" style="display: none;">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                    <span id="truncation-message">Response was truncated due to token limits. Some cases may not have been extracted.</span>
                    <div class="mt-2">
                        <button id="continue-processing-btn" class="btn btn-sm btn-warning">
                            <i class="bi bi-arrow-clockwise"></i> Continue Processing
                        </button>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <!-- Processing details message -->
                <div id="processing-details" class="alert alert-info mb-3" style="display: none;"></div>
                <!-- Error message -->
                <div id="processing-error" class="alert alert-danger" style="display: none;"></div>
            </div>
            <div id="results-content"></div>
        </div>
    </div>
</div>

    <!-- Results Table -->
    {% if show_results %}
    <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0">Extracted Data</h3>
        <button class="btn btn-sm btn-outline-secondary" id="toggle-raw-response">Show Raw Response</button>
    </div>
    <div class="card-body">
        <div id="raw-response" class="mb-3" style="display: none;">
            <h5>Raw API Response:</h5>
            <pre id="raw-response-content" class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"></pre>
        </div>
        <div class="table-responsive">
            <!-- Table will be dynamically inserted here -->
        </div>
    </div>
</div>
    {% endif %}
{% comment %} Initially hide the download buttons {% endcomment %}
<div id="download-buttons" class="card mb-4" style="display: none;">
{% if latest_job and show_results %}
    <div class="card-header">
        <h3 class="card-title mb-0">Export Data</h3>
    </div>
    <div class="card-body">
        <div class="btn-group">
            <a href="{% url 'core:download_results' job_id=latest_job.id format='csv' %}"
               class="btn btn-success" id="download-csv-button">
                <i class="bi bi-file-earmark-spreadsheet"></i> Download CSV
            </a>
            <a href="{% url 'core:download_results' job_id=latest_job.id format='excel' %}"
               class="btn btn-primary" id="download-excel-button">
                <i class="bi bi-file-earmark-excel"></i> Download Excel
            </a>
        </div>
    </div>
{% endif %}
</div>

    <!-- Debug Information -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title mb-0">Processing Details</h3>
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleRawOutput()">Toggle Details</button>
        </div>
        <div class="card-body">
            <div id="raw-output" style="display: none;">
                <pre id="raw-text-content" class="bg-light p-3 rounded"></pre>
            </div>
        </div>
    </div>

    <!-- Add debug section after results-section -->
    <div id="debug-section" class="mt-4" style="display: none;">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">Debug Information</h3>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleDebugView('parsed')">Parsed JSON</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleDebugView('raw')">Raw Markdown</button>
                </div>
            </div>
            <div class="card-body">
                <div id="debug-parsed-view">
                    <h5>Parsed JSON Response:</h5>
                    <pre><code class="language-json" id="debug-json"></code></pre>
                </div>
                <div id="debug-raw-view" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5>Raw Markdown Response:</h5>
                        <button class="btn btn-sm btn-primary" onclick="downloadRawMarkdown()" id="download-markdown-btn" style="display: none;">
                            <i class="bi bi-download"></i> Download Markdown
                        </button>
                    </div>
                    <pre><code class="language-markdown" id="debug-markdown"></code></pre>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/processor.css' %}">
<link rel="stylesheet" href="{% static 'css/status-visible.css' %}">
<style>
    .table-container {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .table-responsive {
        margin: 0;
        padding: 0;
    }
    
    .table {
        margin-bottom: 0;
    }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="{% static 'js/initialize-progress.js' %}"></script>
<script src="{% static 'js/job-progress.js' %}"></script>
<script src="{% static 'js/html-only-scripts.js' %}"></script>
<script>
    // Initialize job progress tracking
    let jobProgress;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize processor page UI components
        initializeProcessorPage();
        
        // Initialize job progress tracker
        jobProgress = new JobProgress({
            statusEndpoint: "{% url 'core:check_job_status' %}"
        });
        
        // Debug/testing buttons
        const testVisibilityBtn = document.getElementById('btn-test-visibility');
        if (testVisibilityBtn) {
            testVisibilityBtn.onclick = function() {
                if (typeof window.testStatusDisplay === 'function') {
                    window.testStatusDisplay();
                }
            };
        }
        
        const showStatusBtn = document.getElementById('btn-show-status');
        if (showStatusBtn) {
            showStatusBtn.onclick = function() {
                if (typeof window.showStatusSection === 'function') {
                    window.showStatusSection();
                }
            };
        }
        
        // Extraction button specific handler for Safari
        $('#extraction-button').on('click', function() {
            if (typeof window.showStatusSection === 'function') {
                window.showStatusSection();
            }
        });
        
        // Form submission
        $('#upload-form').on('submit', function(event) {
            event.preventDefault(); // Prevent the default form submission
            
            // Show loading indicator
            $('#form-processing-indicator').show();
            
            // Show and initialize the status section
            if (typeof window.showStatusSection === 'function') {
                window.showStatusSection();
            }
            
            // Create a FormData object to handle the form data
            const formData = new FormData(this);
            
            // Collect the edited file information
            const fileData = [];
            $('#pdf-files-list tr').each(function(index) {
                const reportName = $(this).find(`input[name="report_name_${index}"]`).val();
                const studyAuthor = $(this).find(`input[name="study_author_${index}"]`).val();
                
                fileData.push({
                    index: index,
                    report_name: reportName,
                    study_author: studyAuthor
                });
            });
            
            // Add the file data as a JSON string
            formData.append('file_data', JSON.stringify(fileData));
            
            // Submit the form via AJAX
            fetch('{% url "core:processor" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Start polling for status updates if we have a job ID
                    if (data.job_id) {
                        // Set initial status
                        const details = document.getElementById('processing-details');
                        if (details) {
                            details.innerHTML = `<p>Job ${data.job_id} started. Waiting for first status update...</p>`;
                            details.style.display = 'block';
                        }
                        
                        // Start tracking job progress
                        jobProgress.startTracking(data.job_id);
                    } else {
                        // Redirect to the job list if no job ID
                        window.location.href = '{% url "core:job_list" %}';
                    }
                } else {
                    // Handle errors
                    $('#form-processing-indicator').hide();
                    
                    // Show error in the modal
                    $('#error-modal-content').text(data.error || 'An unknown error occurred');
                    new bootstrap.Modal(document.getElementById('errorModal')).show();
                }
            })
            .catch(error => {
                $('#form-processing-indicator').hide();
                
                // Show error in the modal
                $('#error-modal-content').text('An error occurred during processing. Please try again.');
                new bootstrap.Modal(document.getElementById('errorModal')).show();
            });
        });

        // Toggle active prompt display
        document.getElementById('toggle-active-prompt').addEventListener('click', function() {
            const container = document.getElementById('active-prompt-container');
            const button = this;
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.innerHTML = '<i class="bi bi-arrows-collapse"></i> Hide Prompt';
            } else {
                container.style.display = 'none';
                button.innerHTML = '<i class="bi bi-arrows-expand"></i> Show Prompt';
            }
        });

        // Toggle schema info display
        document.getElementById('toggle-schema-info').addEventListener('click', function() {
            const container = document.getElementById('schema-info-container');
            const button = this;
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.innerHTML = '<i class="bi bi-arrows-collapse"></i> Hide Schema Info';
            } else {
                container.style.display = 'none';
                button.innerHTML = '<i class="bi bi-arrows-expand"></i> Show Schema Info';
            }
        });
    });
    
    function loadDefaultPrompt() {
        $.get('{% url "core:get_default_prompt" %}', function(data) {
            if (data.success) {
                $('#id_prompt_template').val(data.prompt);
                $('#active-prompt').text(data.prompt);
            }
        });
    }
    
    function loadColumnPrompt() {
        {% if column_prompt %}
        const columnPrompt = `{{ column_prompt|escapejs }}`;
        $('#active-prompt').text(columnPrompt);
        $('#id_prompt_template').val(columnPrompt);
        {% endif %}
    }
    
    function editPrompt() {
        // Show prompt editor
        $('#prompt-editor-container').show();
        
        // Focus on the editor
        $('#id_prompt_template').focus();
    }
    
    function debugPrompt() {
        $('#debug-info').show();
        
        const prompt = $('#id_prompt_template').val();
        const files = document.getElementById('id_pdf_files').files;
        
        $('#debug-state').text(
            `Files selected: ${files.length}\nPrompt length: ${prompt.length} characters`
        );
        
        // Sample request that would be sent
        const sampleRequest = {
            prompt: prompt.substring(0, 100) + '...',
            files: Array.from(files).map(f => f.name)
        };
        
        $('#debug-request').text(JSON.stringify(sampleRequest, null, 2));
    }
    
    function useDefaultPrompt() {
        loadDefaultPrompt();
    }
    
    function toggleRawOutput() {
        $('#raw-output').toggle();
    }
</script>
{% endblock %}