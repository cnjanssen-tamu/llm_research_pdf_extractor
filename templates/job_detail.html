<!-- templates/job_detail.html -->
{% extends "base.html" %}
{% load custom_filters %}

{% block content %}
<div class="container">
    <h2>Job Details: {{ job.name }}</h2>

    <div class="mb-3">
        <p><strong>Job ID:</strong> {{ job.id }}</p>
        <p><strong>Created At:</strong> {{ job.created_at }}</p>
        <p><strong>Status:</strong> {{ job.get_status_display }}</p>
        <p><strong>Total Documents:</strong> {{ job.total_count }}</p>
        <p><strong>Processed Documents:</strong> {{ job.processed_count }}</p>
        {% if job.processing_details %}
        <p><strong>Processing Details:</strong> {{ job.processing_details }}</p>
        {% endif %}
        <div class="progress mb-3">
            <div class="progress-bar {% if pending_continuation %}bg-info{% elif job.status == 'failed' %}bg-danger{% endif %}" role="progressbar" style="width: {{ job.get_progress }}%;" aria-valuenow="{{ job.get_progress }}" aria-valuemin="0" aria-valuemax="100">
                {{ job.get_progress|floatformat:0 }}%
            </div>
        </div>
    </div>

    {% if is_truncated %}
    <div class="alert {% if pending_continuation %}alert-info{% else %}alert-warning{% endif %} mb-4" role="alert">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="alert-heading">Truncated Response Detected</h5>
                <p>{{ continuation_message }}</p>
                <p class="mb-0"><strong>Last case processed:</strong> {{ last_case_number }}</p>
                {% if continuation_status %}
                <p class="mb-0"><strong>Status:</strong> {{ continuation_status }}</p>
                {% endif %}
            </div>
            <div>
                <button type="button" class="btn btn-primary" id="continueProcessing" {% if not continuation_document_id %}disabled{% endif %}>
                    <i class="bi bi-arrow-clockwise"></i> Continue Processing
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    {% if documents %}
    <div class="card mt-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Documents</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Filename</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for document in documents %}
                        <tr>
                            <td>{{ document.filename }}</td>
                            <td>
                                {% if docs_status and document.id in docs_status %}
                                    {% if docs_status|get_item:document.id == 'complete' %}
                                        <span class="badge bg-success">Complete</span>
                                    {% elif docs_status|get_item:document.id == 'processing' %}
                                        <span class="badge bg-info">Processing</span>
                                    {% elif docs_status|get_item:document.id == 'incomplete' %}
                                        <span class="badge bg-warning">Incomplete</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ docs_status|get_item:document.id }}</span>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-secondary">Unknown</span>
                                {% endif %}
                            </td>
                            <td class="d-flex">
                                {% if docs_status and document.id in docs_status and docs_status|get_item:document.id == 'incomplete' %}
                                <form method="post" action="{% url 'core:continue_processing' document.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-warning">
                                        <i class="fas fa-sync-alt"></i> Continue Processing
                                    </button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    {% if results %}
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title mb-0">Extracted Data Table</h3>
        </div>
        <div class="card-body table-container">
            <div class="table-responsive">
                {% if table_html %}
                    {{ table_html|safe }}
                {% else %}
                    <p>No valid case results found for this job.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title mb-0">Download Results</h3>
        </div>
        <div class="card-body">
            <div class="btn-group">
                <a href="{% url 'core:download_results' job_id=job.id format='csv' %}"
                   class="btn btn-success">
                    <i class="bi bi-file-earmark-spreadsheet"></i> Download CSV
                </a>
                <a href="{% url 'core:download_results' job_id=job.id format='excel' %}"
                   class="btn btn-primary">
                    <i class="bi bi-file-earmark-excel"></i> Download Excel
                </a>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">Response Data</h3>
                <div class="btn-group" role="group" aria-label="View toggle">
                    <button class="btn btn-sm btn-outline-secondary active" onclick="toggleView('parsed')" id="parsed-btn">
                        <i class="bi bi-code-square"></i> Parsed JSON
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleView('raw')" id="raw-btn">
                        <i class="bi bi-file-text"></i> Raw Response
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div id="parsed-view">
                <pre><code class="language-json">{{ json_data }}</code></pre>
            </div>
            <div id="raw-view" style="display: none;">
                <pre><code class="language-markdown">{% if results.0.raw_response %}
                    {{ results.0.raw_response }}
                {% else %}
                    {% with found_response=False %}
                        {% for result in results %}
                            {% if result.raw_response and not found_response %}
                                {{ result.raw_response }}
                                {% with found_response=True %}{% endwith %}
                            {% endif %}
                        {% endfor %}
                    {% endwith %}
                {% endif %}</code></pre>
            </div>
        </div>
    </div>

    <!-- Add debug info section -->
    <div class="card mb-4" id="debug-info" style="display: none;">
        <div class="card-header">
            <h3 class="card-title mb-0">Debug Information</h3>
        </div>
        <div class="card-body">
            <h5>Prompt Used:</h5>
            <pre><code class="prompt"></code></pre>
            <h5>Raw API Response:</h5>
            <pre><code class="raw-response"></code></pre>
            <h5>Processed Results:</h5>
            <pre><code class="results"></code></pre>
        </div>
    </div>

    {% for result in results %}
        {% if result.json_result and 'error' in result.json_result %}
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">Processing Error</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-danger">
                    <strong>Error:</strong> {{ result.json_result.error }}
                </div>
                {% if result.raw_response %}
                <div class="mt-3">
                    <h6>Raw API Response:</h6>
                    <div class="d-flex justify-content-between mb-2">
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleRawResponse('raw-response-{{ result.id }}')">
                            Show/Hide Raw Response
                        </button>
                        <a href="{% url 'core:download_raw_markdown' result.id %}" class="btn btn-sm btn-primary">
                            <i class="bi bi-download"></i> Download Raw Text
                        </a>
                    </div>
                    <pre id="raw-response-{{ result.id }}" class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto; display: none; white-space: pre-wrap;">{{ result.raw_response }}</pre>
                </div>
                {% endif %}
                
                <div class="mt-3">
                    <h6>Troubleshooting Tips:</h6>
                    <ul>
                        <li>The JSON response from the model has syntax errors. This can happen if the response is truncated or malformed.</li>
                        <li>Try processing the document again with a simpler prompt that produces less output.</li>
                        <li>Consider splitting large documents into smaller parts.</li>
                        <li>Check the model's response for any error messages or warnings.</li>
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}
    {% endfor %}

    {% else %}
        <p>No results available for this job yet.</p>
    {% endif %}

</div>
{% endblock %}

{% block extra_css %}
<style>
    .table-container {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .table-responsive {
        margin: 0;
        padding: 0;
    }
    
    .table {
        margin-bottom: 0;
    }
    
    .table thead th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 1;
    }
    
    .progress {
        height: 25px;
    }

    .copy-btn {
        position: absolute;
        right: 1rem;
        top: 1rem;
    }

    pre {
        position: relative;
        padding-top: 2.5rem;
    }

    #parsed-view,
    #raw-view {
        transition: opacity 0.3s ease-in-out;
    }

    .btn-group .btn.active {
        background-color: #6c757d;
        color: white;
    }

    pre code {
        white-space: pre-wrap;
        word-wrap: break-word;
    }
</style>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
// Initialize highlight.js if it exists
document.addEventListener('DOMContentLoaded', function() {
    if (typeof hljs !== 'undefined') {
        hljs.highlightAll();
    }
});

function toggleView(view) {
    const parsedView = document.getElementById('parsed-view');
    const rawView = document.getElementById('raw-view');
    const parsedBtn = document.getElementById('parsed-btn');
    const rawBtn = document.getElementById('raw-btn');
    
    if (view === 'parsed') {
        parsedView.style.display = 'block';
        rawView.style.display = 'none';
        parsedBtn.classList.add('active');
        rawBtn.classList.remove('active');
    } else {
        parsedView.style.display = 'none';
        rawView.style.display = 'block';
        parsedBtn.classList.remove('active');
        rawBtn.classList.add('active');
    }
    
    // Rehighlight code blocks if hljs exists
    if (typeof hljs !== 'undefined') {
        document.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightBlock(block);
        });
    }
}

function toggleRawResponse(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = element.style.display === 'none' ? 'block' : 'none';
    }
}

function debugJob() {
    fetch(`/jobs/{{ job.id }}/debug/`)
        .then(response => response.json())
        .then(data => {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.style.display = 'block';
            
            // Update debug sections
            debugInfo.querySelector('.prompt').textContent = data.prompt_template || 'No prompt template';
            debugInfo.querySelector('.raw-response').textContent = 
                data.raw_response ? JSON.stringify(JSON.parse(data.raw_response), null, 2) : 'No raw response';
            debugInfo.querySelector('.results').textContent = 
                JSON.stringify(data.results, null, 2);
                
            // Highlight code
            if (typeof hljs !== 'undefined') {
                document.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightBlock(block);
                });
            }
        })
        .catch(error => console.error('Debug error:', error));
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Add copy buttons to code blocks
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('pre').forEach(block => {
        const button = document.createElement('button');
        button.className = 'btn btn-sm btn-outline-secondary copy-btn';
        button.innerHTML = '<i class="bi bi-clipboard"></i> Copy';
        button.onclick = () => {
            const code = block.querySelector('code').textContent;
            navigator.clipboard.writeText(code);
            button.innerHTML = '<i class="bi bi-clipboard-check"></i> Copied!';
            setTimeout(() => {
                button.innerHTML = '<i class="bi bi-clipboard"></i> Copy';
            }, 2000);
        };
        block.parentNode.insertBefore(button, block);
    });

    // Set initial view state
    document.getElementById('parsed-btn').classList.add('active');

    const continueBtn = document.getElementById('continueProcessing');
    if (continueBtn) {
        continueBtn.addEventListener('click', function() {
            continueBtn.disabled = true;
            continueBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
            
            fetch('', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    action: 'continue_processing',
                    last_case_number: {{ last_case_number|default:0 }},
                    document_id: "{{ continuation_document_id|default:'' }}"
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const toastEl = document.createElement('div');
                    toastEl.classList.add('toast', 'show', 'position-fixed', 'top-0', 'end-0', 'm-3');
                    toastEl.setAttribute('role', 'alert');
                    toastEl.setAttribute('aria-live', 'assertive');
                    toastEl.setAttribute('aria-atomic', 'true');
                    toastEl.innerHTML = `
                      <div class="toast-header bg-success text-white">
                        <strong class="me-auto">Continuation Processing</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                      </div>
                      <div class="toast-body">
                        ${data.message}. The page will refresh when processing is complete.
                      </div>
                    `;
                    document.body.appendChild(toastEl);
                    
                    // Start checking for job completion
                    checkJobStatus();
                } else {
                    alert(data.error || 'An error occurred');
                    continueBtn.disabled = false;
                    continueBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Continue Processing';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                continueBtn.disabled = false;
                continueBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Continue Processing';
            });
        });
    }
});

// Function to check job status periodically
function checkJobStatus() {
    // Check job status every 3 seconds
    const jobStatusInterval = setInterval(function() {
        fetch('/check-job-status/?job_id={{ job.id }}')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'completed' || 
                    data.status === 'completed_with_errors' || 
                    data.status === 'failed' ||
                    data.status === 'pending_continuation' ||
                    data.status === 'pending_continuation_with_errors') {
                    // Processing finished, clear interval and reload
                    clearInterval(jobStatusInterval);
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error checking job status:', error);
            });
    }, 3000);
}
</script>
{% endblock %} 